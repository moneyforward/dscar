description: |
  Calculate the difference of static code analysis results between HEAD branch and BASE branch and then evaluate the result

  Note: If parallelism is set to N > 1, the result will not be calculated correctly in most cases.
parameters:
  analyze:
    description: Specify analysis steps
    type: steps
    default:
      - analyze
  calculate:
    description: Specify the steps for calculating the difference
    type: steps
    default:
      - calculate
  test-results-path:
    description: Specify the value of the path parameter in the store_test_results step if you need to change it
    type: string
    default: "/tmp/test-results"
  vcs-api-token:
    description: Specify the environment variable name where the VCS (Version Control System) API token is set.
    type: env_var_name
    default: GITHUB_TOKEN
  circle_compare_url-path:
    description: "Specify the path of `CIRCLE_COMPARE_URL.txt` if you are using `iynere/compare-url` orb"
    type: string
    default: ""
steps:
  - checkout-analysis-target:
      is-target-branch-base: true
  - declare-commit-ranges:
      circle_compare_url-path: << parameters.circle_compare_url-path >>
      vcs-api-token: << parameters.vcs-api-token >>
  - steps: << parameters.analyze >>
  # steps to calculate the difference
  - set-analysis-result-paths
  - steps: << parameters.calculate >>
  - restore_comment-fingerprints
  - evaluate:
      pattern: &pattern '.*/([0-9]+-|)[0-9a-f]+-DELTA-analysis-result.xml$'
  - transform:
      test-results-path: << parameters.test-results-path >>
      pattern: *pattern
  - store_test_results:
      path: << parameters.test-results-path >>
  - comment:
      pattern: *pattern
      vcs-api-token: << parameters.vcs-api-token >>
  - save_comment-fingerprints
