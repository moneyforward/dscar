description: |
  Set the environment variables referenced by the calculate command.

  - FIRST_RESULT_PATH
  - SECOND_RESULT_PATH
  - DELTA_RESULT_PATH
parameters:
  analysis-results-path:
    description: "Specify the path to save the analysis results if you need to change it (default: /tmp/dscar/analysis-results)"
    type: string
    default: ""
  has-aggregated:
    description: Specify true if analysis results are aggregated
    type: boolean
    default: false
steps:
  - run:
      name: export FIRST_RESULT_PATH SECOND_RESULT_PATH DELTA_RESULT_PATH
      environment:
        ANALYSIS_RESULTS_PATH: << parameters.analysis-results-path >>
      command: |
          set -x

          ANALYSIS_RESULTS_PATH="${ANALYSIS_RESULTS_PATH:-${DSCAR_ANALYSIS_RESULTS_PATH:-/tmp/dscar/analysis-results}}"

          declare -ax FIRST_RESULT_PATH=()
          declare -ax SECOND_RESULT_PATH=()
          declare -ax DELTA_RESULT_PATH=()
          while read -r DIR
          do
            mkdir -p "${DIR}"
            if << parameters.has-aggregated >>
            then RESULT_FILENAME_PREFIX="${CIRCLE_NODE_INDEX}-"
            else RESULT_FILENAME_PREFIX=
            fi

            for KEY in "${!DSCAR_COMMIT_RANGES[@]}"
            do
              COMMITS=( $(echo ${DSCAR_COMMIT_RANGES[$KEY]} | tr -s '.' '\t' ) )

              BASE=${COMMITS[0]}
              HEAD=${COMMITS[1]}
              DELTA=$(echo -n "$KEY" | sha1sum | cut -d' ' -f1)

              FIRST_RESULT_PATH+=( "${DIR}/${RESULT_FILENAME_PREFIX}${HEAD}-analysis-result.xml" )
              SECOND_RESULT_PATH+=( "${DIR}/${RESULT_FILENAME_PREFIX}${BASE}-analysis-result.xml" )
              DELTA_RESULT_PATH+=( "${DIR}/${RESULT_FILENAME_PREFIX}${DELTA}-DELTA-analysis-result.xml" )
            done
          done < <(
            if << parameters.has-aggregated >>
            then
              NODE_TOTAL=$CIRCLE_NODE_TOTAL
              NODE_INDEX=$CIRCLE_NODE_INDEX
              REGEX=".*/@/[0-9]+-[0-9a-f]+-analysis-result\.xml"
            else
              NODE_TOTAL=1
              NODE_INDEX=0
              REGEX=".*/${CIRCLE_NODE_INDEX}/[0-9a-f]+-analysis-result\.xml"
            fi
            ANALYSIS_RESULTS_PATH="${ANALYSIS_RESULTS_PATH:-${DSCAR_ANALYSIS_RESULTS_PATH:-/tmp/dscar/analysis-results}}"
            find "${ANALYSIS_RESULTS_PATH}" -type f -regextype posix-extended -regex "$REGEX" |
            while read -r FILE ; do dirname "$FILE" ; done | sort | uniq |
            circleci tests split --show-counts --index=$NODE_INDEX --total=$NODE_TOTAL
          )

          cat \<<-EOT >> $BASH_ENV
          $(declare -p FIRST_RESULT_PATH)
          $(declare -p SECOND_RESULT_PATH)
          $(declare -p DELTA_RESULT_PATH)
          EOT
