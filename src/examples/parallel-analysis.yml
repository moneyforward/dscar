description: Execute HEAD and BASE analysis jobs in parallel and calculate the difference by using the results of each in subsequent jobs
usage:
  version: 2.1
  orbs:
    dscar: moneyforward/dscar@x.y.z
  workflows:
    analyze-code-statically:
      jobs:
        - dscar/analyze: &analyze
            name: analyze head using eslint
            executor:
              name: dscar/default
              project-git_url: << pipeline.project.git_url >>
              git-base_revision: << pipeline.git.base_revision >>
              git-revision: << pipeline.git.revision >>
              docker-image: circleci/node:10.16.0
            pre-steps:
              - run: npm install
            test-results-path: ""
            analyze:
              - dscar/analyze:
                  prepare: []
                  starting-points: client/src
                  analysis-name: ESLint
                  analysis-command: npx
                  analysis-arguments: eslint --ext .js,.jsx,.ts,.tsx -f checkstyle
            post-steps:
              - store_artifacts:
                  path: /tmp/dscar/analysis-results
              - persist_to_workspace:
                  root: /tmp/dscar
                  paths:
                    - analysis-results
            requires:
              - checkout
        - dscar/analyze:
            <<: *analyze
            name: analyze base using eslint
            is-target-branch-base: true
        - dscar/calculate:
            executor:
              name: dscar/default
              project-git_url: << pipeline.project.git_url >>
              git-base_revision: << pipeline.git.base_revision >>
              git-revision: << pipeline.git.revision >>
            pre-steps:
              - attach_workspace:
                  at: /tmp/dscar
            requires:
              - analyze head using eslint
              - analyze base using eslint
